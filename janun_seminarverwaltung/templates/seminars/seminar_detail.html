{% extends "base.html" %}

{% load crispy_forms_tags rules svg %}

{% block title %}{{ block.super }} {{ object.title }}{% endblock %}

{% block content %}
<a class="backlink" href="{% url 'seminars:list' %}">← Alle Seminare</a>


<div class="clearfix">
  <div class="float-md-left">
    <h1 class="float-md-left h2 font-weight-bold">
      {{ object.title }}
    </h1>
  </div>

  {% has_perm 'seminars.delete_seminar' user object as can_delete %}
  {% if can_delete %}
    <a class="float-md-right btn btn-outline-danger my-2"
       href="{% url 'seminars:delete' object.id %}" data-toggle="modal" data-target="#deleteModal">
       <span style="margin-left: -8px">{% svg 'icon-trash' %}</span>
       löschen
     </a>
  {% endif %}
</div>


<p>
  {% if object.start.date == object.end.date %}
    {{ object.start|date:"d.m.y" }}
  {% else %}
    {{ object.start|date:"d.m.y" }}
    bis {{ object.end|date:"d.m.y" }}
  {% endif %}
  {% if object.location %}
    in {{ object.location }}
  {% endif %}
  <br>
  <span class="text-secondary">
    Angemeldet
    {% if object.author %}
      von <a class="text-secondary" href="{{ object.author.get_absolute_url }}">{{ object.author }}</a>
    {% endif %}
    am {{ object.created|date:"d.m.y" }}<br>
    Gruppe:
    {% if object.group %}
      <a class="text-secondary" href="{% url 'groups:detail' object.group.id %}">{{ object.group.name }}</a>
    {% else %}
      keine Gruppe
    {% endif %}
  </span>
</p>


{% include "seminars/_state.html" %}

{% include "seminars/_seminar_detail_fields.html" %}

{% include "seminars/_comments.html" %}

{% endblock %}


{% block modal %}
  <div class="modal" tabindex="-1" role="dialog" id="deleteModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Seminar löschen?</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form method="post" action="{% url 'seminars:delete' object.pk %}">
          <div class="modal-body">
            <p>Möchtest Du wirklich das Seminar <strong>{{ object }}</strong> löschen?</p>
            {{ delete_form | crispy }}
          </div>
          <div class="modal-footer">
            {% csrf_token %}
            <button type="button" class="btn btn-link" data-dismiss="modal">Abbrechen</button>
            <button type="submit" class="btn btn-danger">Löschen</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
  $('#stateModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var buttonName = button.data('button-name');
    var transitionColor = button.data('transition-color');
    var formAction = button.data('form-action')
    var modal = $(this);
    modal.find('.modal-title').text('Seminar ' + buttonName + '?');
    modal.find('.modal-body p').text('Seminar ' + buttonName + '?');
    modal.find('form').attr('action', formAction);
    modal.find('[type=submit]').text(buttonName);
    modal.find('[type=submit]').attr('class', 'btn btn-' + transitionColor);
    modal.find('.modal-title').attr('class', 'modal-title text-' + transitionColor);

  })
</script>

<script type="text/javascript">
function get_total(fields) {
  var newValue = 0.0;
  $.each(fields, function (index, field) {
    value = $('#id_' + field).val();
    if ($.isNumeric(value)) {
      newValue = newValue + parseFloat(value);
    }
  });
  return newValue;
}

var ausgaben_fields = ['ausgaben_verpflegung', 'ausgaben_unterkunft', 'ausgaben_referenten', 'ausgaben_fahrtkosten', 'ausgaben_sonstiges']
$.each(ausgaben_fields, function (index, field) {
  $('#id_' + field).change(function () {
    var ausgaben_insg = get_total(ausgaben_fields)
    $('#id_ausgaben_insg').val(ausgaben_insg.toFixed(2)).change();
  });
});

var einnahmen_fields = ['einnahmen_beitraege', 'einnahmen_oeffentlich', 'einnahmen_sonstiges']
$.each(einnahmen_fields, function (index, field) {
  $('#id_' + field).change(function () {
    var einnahmen_insg = get_total(einnahmen_fields)
    $('#id_einnahmen_insg').val(einnahmen_insg.toFixed(2)).change();
  });
});

$.each(['einnahmen_insg', 'ausgaben_insg'], function (index, field) {
  $('#id_' + field).change(function () {
    var ausgaben_minus_einnahmen = get_total(['ausgaben_insg']) - get_total(['einnahmen_insg']);
    $('#id_ausgaben_minus_einnahmen').val(ausgaben_minus_einnahmen.toFixed(2)).change();
  });
});

$.each(['foerderbedarf', 'vorschuss'], function (index, field) {
  $('#id_' + field).change(function () {
    var resterstattung = get_total(['foerderbedarf']) - get_total(['vorschuss']);
    $('#id_resterstattung').val(resterstattung.toFixed(2)).change();
  });
});

$('#id_tnt_total').change(function() {
  var rate = parseFloat($('#id_foerdersatz').val());
  var tnt = parseInt($('#id_tnt_total').val());
  var hasGroup = $('#id_group').val() !== '';
  var days = $('#id_planned_training_days').val();
  var limit;
  var foerder = rate * tnt;

  if (!hasGroup) {
    if (days <= 3) {
      limit = 300;
    } else {
      limit = 300 + 200 * (days - 3);
    }
    if (limit > 1000) limit = 1000;
    console.log('limit: ' + limit + '; foerder: ' + foerder);
    if (foerder >= limit) {
      foerder = limit;
    }
  }

  $('#id_foerder_max').val(foerder.toFixed(2)).change();
})


function updateTrainingDays() {
  if ($('#id_training_days').val() === '') {
    $('#id_training_days').val($('#id_planned_training_days').val()).change()
  }
}
updateTrainingDays();


function updateTntJfg() {
  if ($('#id_tnt_jfg')[0].defaultValue !== '') return;
  var tn_jfg = $('#id_tn_jfg').val();
  var training_days = $('#id_training_days').val();
  if (tn_jfg !== '' && training_days !== '') {
    var tnt_jfg = parseInt(tn_jfg) * parseInt(training_days);
    $('#id_tnt_jfg').val(tnt_jfg).change();
  }
}
$('#id_tn_jfg').change(updateTntJfg);
$('#id_training_days').change(updateTntJfg);


function updateTntRl() {
  if ($('#id_tnt_total')[0].defaultValue !== '') return;
  var tn_total = $('#id_tn_total').val();
  var training_days = $('#id_training_days').val();
  if (tn_total !== '' && training_days !== '') {
    var tnt_total = parseInt(tn_total) * parseInt(training_days);
    $('#id_tnt_total').val(tnt_total).change();
  }
}
$('#id_tn_total').change(updateTntRl);
$('#id_training_days').change(updateTntRl);

$('form').areYouSure();
</script>

<style>
  .input-group-text {
    background: transparent;
  }
</style>

{% endblock %}
